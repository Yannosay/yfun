<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tic Tac Toe</title>
<style>
body{
  margin:0;
  font-family:sans-serif;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  height:100vh;
  background:#ddd;
  color:#333;
}

h1{ margin:10px;}

#login,#servers,#countdown,#game{
  display:none;
  flex-direction:column;
  align-items:center;
}

button,input{
  padding:10px;
  margin:5px;
  font-size:16px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

#serverList{
  margin-bottom:10px;
}

#playerList{
  margin-top:10px;
}

#board{
  display:grid;
  grid-template-columns:repeat(3,80px);
  grid-template-rows:repeat(3,80px);
  gap:10px;
  margin-top:20px;
}

.cell{
  background:#eee;
  border-radius:12px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:50px;
  cursor:pointer;
  transition:0.2s;
}

.cell.invalid{
  animation:shake 0.3s;
}

@keyframes shake{
  0%{transform:translateX(0);}
  25%{transform:translateX(-5px);}
  50%{transform:translateX(5px);}
  75%{transform:translateX(-5px);}
  100%{transform:translateX(0);}
}

#turnText{margin-top:10px; font-weight:bold;}

.win-line{
  position:absolute;
  background:limegreen;
  height:6px;
  width:0;
  border-radius:3px;
  top:0;
  left:0;
  transform-origin:center;
  transition: all 0.5s ease;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>Tic Tac Toe</h1>

<div id="login">
<input id="name" placeholder="Username (4+)">
<button onclick="login()">Join Server</button>
</div>

<div id="servers">
<h3>Choose Server</h3>
<div id="serverList"></div>
</div>

<div id="countdown">
<h2 id="countText">Game starts in 5...</h2>
</div>

<div id="game">
<div id="playerList"></div>
<div id="turnText"></div>
<div style="position:relative;">
  <div id="board"></div>
  <div id="winLine" class="win-line"></div>
</div>
</div>

<script>
let db=null;
try{
  const firebaseConfig = {
    apiKey: "AIzaSyAIXlO32dXQaJSTJqnlLZ7ylapdfukuwCI",
    authDomain: "drawtogether-fe581.firebaseapp.com",
    databaseURL: "https://drawtogether-fe581-default-rtdb.firebaseio.com",
    projectId: "drawtogether-fe581",
    storageBucket: "drawtogether-fe581.firebasestorage.app",
    messagingSenderId: "388416050930",
    appId: "1:388416050930:web:eee1b382f33a137ce5226b"
  };
  firebase.initializeApp(firebaseConfig);
  db=firebase.database();
}catch(e){console.log("Firebase offline");}

let username="", server="", symbol="", turn="X";
let board=Array(9).fill("");
let countdownInterval=null;
let playersRef=null;

document.getElementById("login").style.display="flex";

// ===== LOGIN & SERVER =====
function login(){
  username=document.getElementById("name").value;
  if(username.length<4){ alert("Min 4 chars"); return; }
  document.getElementById("login").style.display="none";
  showServers();
}

function showServers(){
  const div=document.getElementById("serverList");
  div.innerHTML="";
  for(let i=1;i<=5;i++){
    const b=document.createElement("button");
    b.innerText="Server "+i;
    b.onclick=()=>joinServer("server"+i);
    div.appendChild(b);
  }
  document.getElementById("servers").style.display="flex";
}

function joinServer(s){
  server=s;
  document.getElementById("servers").style.display="none";

  playersRef = db.ref("rooms/"+server+"/players");

  playersRef.once("value").then(snap=>{
    const players = snap.val()||{};
    if(Object.keys(players).length>=2){ alert("Server full"); showServers(); return; }
    symbol = Object.values(players).includes("X")? "O":"X";
    const ref = playersRef.push();
    ref.set({name:username,symbol:symbol});
    setupGameStart();
  });
}

// ===== COUNTDOWN =====
function setupGameStart(){
  playersRef.on("value",snap=>{
    const players = snap.val()||{};
    renderPlayerList(players);
    if(Object.keys(players).length===2){
      document.getElementById("countdown").style.display="flex";
      let counter=5;
      document.getElementById("countText").innerText="Game starts in "+counter+"...";
      countdownInterval=setInterval(()=>{
        counter--;
        if(counter>0){
          document.getElementById("countText").innerText="Game starts in "+counter+"...";
        } else {
          clearInterval(countdownInterval);
          document.getElementById("countdown").style.display="none";
          startGame();
        }
      },1000);
    }
  });
}

function renderPlayerList(players){
  const div=document.getElementById("playerList");
  div.innerHTML="Players: "+Object.values(players).map(p=>p.name+"("+p.symbol+")").join(", ");
}

// ===== GAME LOGIC =====
function startGame(){
  document.getElementById("game").style.display="flex";
  buildBoard();
  updateTurn();

  db.ref("rooms/"+server+"/state").on("value",snap=>{
    const d = snap.val();
    if(!d) return;
    board=d.board;
    turn=d.turn;
    renderBoard();
    updateTurn();
  });

  db.ref("rooms/"+server+"/state").once("value").then(snap=>{
    if(!snap.exists()){
      db.ref("rooms/"+server+"/state").set({board,turn:"X"});
    }
  });
}

function buildBoard(){
  const boardDiv=document.getElementById("board");
  boardDiv.innerHTML="";
  for(let i=0;i<9;i++){
    const cell=document.createElement("div");
    cell.className="cell";
    cell.onclick=()=>makeMove(i);
    boardDiv.appendChild(cell);
  }
  renderBoard();
}

function makeMove(i){
  const cell=document.getElementById("board").children[i];
  if(turn!==symbol){ flash(cell); return; }
  if(board[i]){ flash(cell); return; }

  board[i]=symbol;

  if(checkWin(board)){
    renderBoard();
    drawWinLine(board);
    alert(symbol+" wins!");
    board=Array(9).fill("");
  }

  turn = turn==="X"?"O":"X";
  sync();
  renderBoard();
  updateTurn();
}

function flash(cell){
  cell.classList.add("invalid");
  setTimeout(()=>cell.classList.remove("invalid"),300);
}

function sync(){
  db.ref("rooms/"+server+"/state").set({board,turn});
}

function renderBoard(){
  const boardDiv=document.getElementById("board");
  for(let i=0;i<9;i++){
    boardDiv.children[i].innerText=board[i]||"";
  }
}

function updateTurn(){
  document.getElementById("turnText").innerText="You: "+symbol+" | Turn: "+turn;
}

// ===== CHECK WIN =====
function checkWin(b){
  const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  return wins.some(line=>line.every(idx=>b[idx]===b[line[0]] && b[idx]));
}

// ===== WIN LINE ANIMATION =====
function drawWinLine(b){
  const wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  const lineDiv=document.getElementById("winLine");
  lineDiv.style.width="0";
  for(let line of wins){
    if(line.every(idx=>b[idx]===b[line[0]] && b[idx])){
      const start=line[0],end=line[2];
      const boardDiv=document.getElementById("board");
      const cellSize=boardDiv.children[0].offsetWidth + 10; // cell + gap
      let top=0, left=0, width=cellSize*3, angle=0;
      if(line[0]==0 && line[1]==1 && line[2]==2){top=cellSize*0; angle=0;} // top
      else if(line[0]==3){top=cellSize; angle=0;} // middle row
      else if(line[0]==6){top=cellSize*2; angle=0;} // bottom row
      else if(line[0]==0 && line[1]==3){top=0; left=0; width=cellSize*3; angle=90;} // left col
      else if(line[0]==1){top=0; left=cellSize; width=cellSize*3; angle=90;} // middle col
      else if(line[0]==2){top=0; left=cellSize*2; width=cellSize*3; angle=90;} // right col
      else if(line[0]==0 && line[1]==4){angle=45; width=cellSize*3; top=0; left=0;} // diag \
      else if(line[0]==2 && line[1]==4){angle=-45; width=cellSize*3; top=0; left=0;} // diag /
      lineDiv.style.top=top+"px";
      lineDiv.style.left=left+"px";
      lineDiv.style.transform=`rotate(${angle}deg)`;
      setTimeout(()=>{lineDiv.style.width=width+"px";},50);
    }
  }
}
</script>
</body>
</html>
