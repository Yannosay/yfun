<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultimate Tic Tac Toe</title>
<style>
body{
  margin:0;
  background:#0b0b0b;
  color:white;
  font-family:Consolas, monospace;
  display:flex;
  flex-direction:column;
  align-items:center;
}

h1{ text-shadow:0 0 15px magenta; }

#login,#servers,#game,#countdown{
  display:none;
  flex-direction:column;
  align-items:center;
}

button,input{
  padding:10px;
  margin:5px;
  font-size:16px;
  background:#1a1a1a;
  color:#ff00ff;
  border:none;
  cursor:pointer;
}

#ultimate{
  display:grid;
  grid-template-columns:repeat(3, auto);
  gap:10px;
  margin-top:20px;
  position:relative;
}

.small{
  display:grid;
  grid-template-columns:repeat(3,70px);
  grid-template-rows:repeat(3,70px);
  gap:4px;
  padding:5px;
  background:#151515;
  border:2px solid magenta;
  transition:0.3s;
  animation:wiggle 2s infinite;
  position:relative;
}

@keyframes wiggle{
  0%{transform:rotate(-1deg);}
  50%{transform:rotate(1deg);}
  100%{transform:rotate(-1deg);}
}

.cell{
  background:#2a2a2a;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:40px;
  cursor:pointer;
  color:#ff00ff;
  transition:0.2s;
}

.cell.invalid{
  animation:shake 0.2s;
}

@keyframes shake{
  0%{transform:translateX(0);}
  25%{transform:translateX(-5px);}
  50%{transform:translateX(5px);}
  75%{transform:translateX(-5px);}
  100%{transform:translateX(0);}
}

#turnText{
  margin-top:10px;
  font-size:20px;
  color:#ff00ff;
  text-shadow:0 0 5px magenta;
}

.win-line{
  position:absolute;
  background:lime;
  height:4px;
  width:100%;
  top:50%;
  left:0;
  transform-origin:center;
  pointer-events:none;
}
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<h1>ULTIMATE TIC TAC TOE</h1>

<div id="login">
<input id="name" placeholder="Username (4+)">
<button onclick="login()">JOIN SERVER</button>
</div>

<div id="servers">
<h3>Choose Server</h3>
<div id="serverButtons"></div>
</div>

<div id="countdown">
<h2 id="countText">Game starts in 5...</h2>
</div>

<div id="game">
<h2 id="turnText"></h2>
<div id="ultimate"></div>
</div>

<script>
let db=null;
try{
const firebaseConfig = {
  apiKey: "AIzaSyAIXlO32dXQaJSTJqnlLZ7ylapdfukuwCI",
  authDomain: "drawtogether-fe581.firebaseapp.com",
  databaseURL: "https://drawtogether-fe581-default-rtdb.firebaseio.com",
  projectId: "drawtogether-fe581",
  storageBucket: "drawtogether-fe581.firebasestorage.app",
  messagingSenderId: "388416050930",
  appId: "1:388416050930:web:eee1b382f33a137ce5226b"
};
firebase.initializeApp(firebaseConfig);
db=firebase.database();
}catch(e){console.log("Firebase offline");}

let username="", server="", symbol="", turn="X", nextBoard=-1;
let board=Array(9).fill().map(()=>Array(9).fill(""));
let smallWins=Array(9).fill("");
let countdownInterval=null;
let playersRef=null;

// ===== LOGIN & SERVER =====
document.getElementById("login").style.display="flex";

function login(){
  username=document.getElementById("name").value;
  if(username.length<4){ alert("Min 4 chars"); return; }
  document.getElementById("login").style.display="none";
  showServers();
}

function showServers(){
  const div=document.getElementById("serverButtons");
  div.innerHTML="";
  for(let i=1;i<=5;i++){
    const b=document.createElement("button");
    b.innerText="Server "+i;
    b.onclick=()=>joinServer("server"+i);
    div.appendChild(b);
  }
  document.getElementById("servers").style.display="flex";
}

function joinServer(s){
  server=s;
  document.getElementById("servers").style.display="none";

  // assign random symbol
  playersRef = db.ref("rooms/"+server+"/players");
  playersRef.once("value").then(snap=>{
    const players = snap.val() || {};
    const count = Object.keys(players).length;
    symbol = (Math.random()<0.5 && count===0) ? "X" : (count===0?"O": (count===1 && !Object.values(players).includes("X")?"X":"O"));
    const ref = playersRef.push();
    ref.set({name:username,symbol:symbol});
    setupGameStart();
  });
}

// ===== GAME START TIMER =====
function setupGameStart(){
  db.ref("rooms/"+server+"/players").on("value",snap=>{
    const players = snap.val() || {};
    if(Object.keys(players).length===2){
      document.getElementById("countdown").style.display="flex";
      let counter=5;
      document.getElementById("countText").innerText="Game starts in "+counter+"...";
      countdownInterval=setInterval(()=>{
        counter--;
        if(counter>0){
          document.getElementById("countText").innerText="Game starts in "+counter+"...";
        } else {
          clearInterval(countdownInterval);
          document.getElementById("countdown").style.display="none";
          startGame();
        }
      },1000);
    }
  });
}

// ===== GAME LOGIC =====
function startGame(){
  document.getElementById("game").style.display="flex";
  buildBoard();
  updateTurn();

  db.ref("rooms/"+server+"/state").on("value",snap=>{
    const d = snap.val();
    if(!d) return;
    board=d.board;
    smallWins=d.smallWins;
    turn=d.turn;
    nextBoard=d.nextBoard;
    render();
    updateTurn();
  });

  // initialize state if empty
  db.ref("rooms/"+server+"/state").once("value").then(snap=>{
    if(!snap.exists()){
      db.ref("rooms/"+server+"/state").set({board,smallWins,turn,nextBoard});
    }
  });
}

function buildBoard(){
  const U=document.getElementById("ultimate");
  U.innerHTML="";
  for(let s=0;s<9;s++){
    const small=document.createElement("div");
    small.className="small";
    for(let c=0;c<9;c++){
      const cell=document.createElement("div");
      cell.className="cell";
      cell.onclick=()=>move(s,c);
      small.appendChild(cell);
    }
    U.appendChild(small);
  }
  render();
}

function move(s,c){
  const cell = document.getElementById("ultimate").children[s].children[c];

  if(turn!==symbol){ flashCell(cell); return; }
  if(nextBoard!=-1 && s!=nextBoard){ flashCell(cell); return; }
  if(board[s][c]){ flashCell(cell); return; }

  board[s][c]=symbol;

  if(check(board[s])) smallWins[s]=symbol;
  if(check(smallWins)){
    render();
    drawWinLine(smallWins);
    alert(symbol+" WINS GAME");
    smallWins.fill("");
    board=Array(9).fill().map(()=>Array(9).fill(""));
  }

  nextBoard = (smallWins[c]) ? -1 : c;
  turn = turn=="X"?"O":"X";

  sync();
  render();
  updateTurn();
}

function flashCell(cell){
  cell.classList.add("invalid");
  setTimeout(()=>cell.classList.remove("invalid"),200);
}

function sync(){
  if(!db) return;
  db.ref("rooms/"+server+"/state").set({board,smallWins,turn,nextBoard});
}

function render(){
  const U=document.getElementById("ultimate").children;
  for(let s=0;s<9;s++){
    U[s].classList.toggle("active", nextBoard==-1 || nextBoard==s);
    if(smallWins[s]) U[s].style.borderColor="lime"; else U[s].style.borderColor="magenta";
    const cells=U[s].children;
    for(let c=0;c<9;c++){
      cells[c].innerText=board[s][c]||"";
    }
  }
}

function updateTurn(){
  document.getElementById("turnText").innerText="You are: "+symbol+" | Turn: "+turn;
}

// ===== CHECK WIN =====
function check(a){
  const L=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  return L.some(l=>a[l[0]] && a[l[0]]==a[l[1]] && a[l[0]]==a[l[2]]);
}

// ===== WIN LINE =====
function drawWinLine(smallWins){
  // placeholder, can add SVG or div lines
}
</script>
</body>
</html>
